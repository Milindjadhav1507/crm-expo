<div class="ticket-detail-container">
  <div class="actions-header">
    <button mat-stroked-button (click)="onBack()">
      <mat-icon>arrow_back</mat-icon>
      Back to Tickets
    </button>
    <div class="right-actions" *ngIf="ticket">
      <button mat-stroked-button color="primary" (click)="onEdit()">
        <mat-icon>edit</mat-icon>
        Edit
      </button>
      <button mat-stroked-button color="warn" (click)="onClose()" [disabled]="ticket.status === 'closed'">
        <mat-icon>close</mat-icon>
        Close Ticket
      </button>
    </div>
  </div>

  <mat-card class="ticket-card" *ngIf="ticket">
    <mat-card-header>
      <mat-card-title>
        <div class="title-row">
          <span class="ticket-id">#{{ticket.id}}</span>
          {{ticket.title}}
        </div>
      </mat-card-title>
      <mat-card-subtitle>
        <div class="status-row">
          <mat-chip-set>
            <mat-chip [color]="getStatusColor(ticket.status)" selected>{{ticket.status}}</mat-chip>
            <mat-chip [color]="getPriorityColor(ticket.priority)" selected>{{ticket.priority}}</mat-chip>
            <mat-chip>{{ticket.category}}</mat-chip>
          </mat-chip-set>
        </div>
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <mat-tab-group>
        <!-- Details Tab -->
        <mat-tab label="Details">
          <div class="tab-content">
            <div class="info-grid">
              <div class="info-item">
                <label>Created By</label>
                <span>{{ticket.createdBy || 'N/A'}}</span>
              </div>
              <div class="info-item">
                <label>Assigned To</label>
                <span>{{ticket.assignedTo || 'Unassigned'}}</span>
              </div>
              <div class="info-item">
                <label>Created At</label>
                <span>{{formatDate(ticket.createdAt)}}</span>
              </div>
              <div class="info-item">
                <label>Last Updated</label>
                <span>{{ticket.updatedAt ? formatDate(ticket.updatedAt) : 'Not updated'}}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="description-section">
              <h3>Description</h3>
              <p>{{ticket.description}}</p>
            </div>

            <mat-divider></mat-divider>

            <div class="attachments-section" *ngIf="ticket.attachments?.length">
              <h3>Attachments</h3>
              <div class="attachment-list">
                <a *ngFor="let attachment of ticket.attachments" 
                   [href]="attachment.url || attachment" 
                   class="attachment-item" 
                   target="_blank">
                  <mat-icon>attach_file</mat-icon>
                  <span>{{attachment?.name ? attachment.name : attachment}}</span>
                </a>
              </div>
            </div>
          </div>
        </mat-tab>

        <!-- Communication History Tab -->
        <mat-tab label="Communication History">
          <div class="tab-content">
            <div class="communication-header">
              <h3>Communication History</h3>
              <button mat-raised-button color="primary" (click)="onAddComment()">
                <mat-icon>add_comment</mat-icon>
                Add Comment
              </button>
            </div>

            <div class="communication-list">
              <div *ngFor="let comm of ticket.communicationHistory" 
                   class="communication-item"
                   [ngClass]="comm.type">
                <div class="message-header">
                  <span class="sender">{{comm.author}}</span>
                  <span class="timestamp">{{formatDate(comm.timestamp)}}</span>
                </div>
                <div class="message-content">
                  {{comm.message}}
                </div>
              </div>
              
              <div *ngIf="!ticket.communicationHistory.length" class="no-communications">
                <p>No communications yet.</p>
              </div>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card-content>
  </mat-card>

  <div *ngIf="!ticket" class="not-found-container">
    <mat-card>
      <mat-card-content>
        <h2>Ticket Not Found</h2>
        <p>The requested ticket could not be found.</p>
        <button mat-stroked-button (click)="onBack()">
          <mat-icon>arrow_back</mat-icon>
          Back to Tickets
        </button>
      </mat-card-content>
    </mat-card>
  </div>
</div>